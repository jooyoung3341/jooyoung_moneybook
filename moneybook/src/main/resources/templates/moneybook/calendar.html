<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.na/thymeleaf/layout"
	    layout:decorate="~{layout/default}">
<head>
<th:block layout:fragment="css">
<style>
.cal_top{
    text-align: left;
    font-size: 20px;
    padding:0px 0px 0px 350px;
}
.cal{
    text-align: left;    
    padding:0px 0px 0px 100px;
}
table.calendar{
    border: 1px solid black;
    display: inline-table;
    text-align: left;
}
table.calendar td{
    vertical-align: top;
    border: 1px solid black;
    width: 100px;
}

</style>
</th:block>
<meta charset="UTF-8">
<title>가계부 달력</title>
</head>
<div layout:fragment="content">
  		<div class="cal_top">
  		<!-- 이전달로 이동 -->
        <a href="#" id="movePrevMonth">
        	<span id="prevMonth" class="cal_tit">&lt;</span>
        </a>
        <!-- 년 -->
        <span id="cal_top_year"></span>
        <!-- 월 -->
        <span id="cal_top_month"></span>
        <!-- 다음달로 이동 -->
        <a href="#" id="moveNextMonth">
        	<span id="nextMonth" class="cal_tit">&gt;</span>
        </a>
        <span>
        <span class="badge badge-danger" style="height:30px;">지출</span><span id="exsum" class="text-danger"></span>
        <span class="badge badge-info" style="height:30px;">수입</span><span id="easum" class="text-info"></span>
    	</span>
    </div>
    <div id="getCalendar" class="cal">
    </div>
    <div id="getSum"></div>
 
 <!-- modal -->
 <div class="modal fade bd-example-modal-xl" id="calendar_modal" tabindex="-1" role="dialog"
 		aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl" role="document">
		<div class="modal-content">
			<div class="modal-header">
			  	<h5 class="modal-title"></h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			
			<div class="modal-body">
			<div class="row">
			<div class="col-md-7">
						
					<div id="modal_eno"></div>
					지출	
					<div class="form-group" id="modal_expense"></div>
					수입
					<div class="form-group" id="modal_earnings"></div>
					
					<div class="form-group" id="modal_price"></div>
					<div class="form-group" id="modal_cartegory"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">닫기</button>
					</div>
			</div>
	
			
			<div class="col-md-4">
				<ul class="nav nav-tabs">
					<li class="nav-item">
						<a class="nav-link active" data-toggle="tab" href="#detail">상세 보기</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" data-toggle="tab" href="#expense">지출 등록</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" data-toggle="tab" href="#earnings">수입 등록</a>
					</li>
				</ul>
				
				<div id="myTabContent" class="tab-content">
					<!-- 상세보기 -->
					<div class="tab-pane fade" id="detail">
						<form method="post" id="expense_form"  name="form">
							
						</form>
					</div>
					
					<!-- 지출 등록 -->
					<div class="tab-pane fade" id="expense">
						<form method="post" id="expense_form"  name="form">
							<input type="hidden" id="ex_moneybook_type" value="expense">
							<div class="form-group">
								<label class="col-form-label" for="inputDefault">날짜</label>
								<input type="date" class="form-control" id="ex_insert_date" required="required"/>
							</div>
							
							<div class="form-group">
						    	<select class="custom-select" id="type">
						      		<option value="cash">현금</option>
						      		<option value="card">카드</option>
						    	</select>
					 		</div>
					 		
					 		<div class="form-group">
								<label class="col-form-label" for="inputDefault">금액</label>
					  			<input type="text" class="form-control"  id="ex_price" required="required" maxlength="12">
							</div>
					
							<div class="form-group">
								<label class="col-form-label" for="inputDefault">사용내역</label>
					  			<input type="text" class="form-control" id="ex_cartegory" required="required">
							</div>
							<button type="button" class="btn btn-primary" id="expense_insert">등록</button>    
						</form>
					</div>
					
					<!-- 수입 등록 -->
					<div class="tab-pane fade" id="earnings">
						<form method="post" id="earnings_form" name="form">
							<input type="hidden" id="ea_moneybook_type" value="earnings">
							<div class="form-group">
								<label class="col-form-label" for="inputDefault">날짜</label>
								<input type="date" class="form-control" id="ea_insert_date">
							</div>
							<div class="form-group">
								<label class="col-form-label" for="inputDefault">금액</label>
								<input type="text" class="form-control" id="ea_price" maxlength="12">
							</div>
							<div class="form-group">
								<label class="col-form-label" for="inputDefault">수입처</label>
								<input type="text" class="form-control" id="ea_cartegory" >
							</div>
							<button type="button" class="btn btn-primary" id="earnings_insert">등록</button>
						</form>
					</div>
				</div>
				
			</div>
			</div>
			</div>
			
		</div>
	</div>
</div>
			
			
</div>

<th:block layout:fragment="script"> 
<script>
window.onload = function(){
	statusSelect();
	calendar();
	initDate();
	setData(year, month);
}

document.getElementById("ex_insert_date").valueAsDate = new Date();
document.getElementById("ea_insert_date").valueAsDate = new Date();

$(document).ready(function() {
	//저번 월 이동
    $("#movePrevMonth").on("click", function(){
    	movePrevMonth();
    	});
	//다음 월 이동
    $("#moveNextMonth").on("click", function(){
    	moveNextMonth();
    	});
}); 

//
var today = 0;
//년 
var year = 0;
//월
var month = 0;  
//달력에 월 처리할 변수
var firstDay = 0; 
var lastDay = 0;
//테이블 td테그값을 넣어 달력 일자를 표시하기 위한 변수
var tdDay = null;
//해당 달에 있는 가계부 넣을 배열
var calendarList = new Array(); 

//calendar 그리기
function calendar(){
    var caldisp = "";
    var calnum = 0;
    caldisp += "<table class='calendar'>";
    caldisp += "<tr><th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th></tr>";
    //열 구하기
    for(var i = 0; i < 6; i++){
    	caldisp += "<tr height='100'>";
        //행 구하기
    	for(var j = 0; j < 7 ;j++){
        	caldisp += "<td style='text-overflow:ellipsis;overflow:hidden;white-space:nowrap'>";
        	caldisp += "<a href='#'>"
        	caldisp += "<div class='cal_day' id='cal_moneybook"+calnum+"' name='cal_moneybook'></div>";
        	caldisp += "</a>"
        	caldisp += "</td>";
        	
        	calnum++
        }
        caldisp += "</tr>";
    }
    caldisp += "</table>";
    $("#getCalendar").html(caldisp);
}

//날짜 초기화
function initDate(){
    tdDay = $("td div.cal_day")
    dayCount = 0;
    today = new Date();
    year = today.getFullYear();
    month = today.getMonth()+1;
    //10월이하 01,02,03 으로 변경
    if(month<10){
        month=String("0"+month);
    }
    firstDay = new Date(year,month-1,1);
    lastDay = new Date(year,month,0);
}

//calendar 날짜표시
function drawDays(calendarList){
	//지출 합계
	var exsum = 0;
	//수입 합계
	var easum = 0;
	var sumdisp = "";
	//달력 상단에 년과 월 지정
    $("#cal_top_year").text(year);
    $("#cal_top_month").text(month);
	//일자 표시
    for(var i = firstDay.getDay(); i < firstDay.getDay() + lastDay.getDate(); i++){
        tdDay.eq(i).text(++dayCount);     
		}

    //달력에 지출, 수입내역 작성
	$(calendarList).each(function (idx, item){
		//0
		var num = firstDay.getDay()
		//1일부터 시작 할 위치 지정
		// 달력 일 칸 마다 id값이 일자와 동일하게 되 있으므로 시작할 아이디 일자를 정함
		var calnum = parseInt(item.day) + parseInt(num-1);
		
		//수입과 지출 색을 다르게 지정
		//수입 내역
 		if(item.moneybook_type == "earnings"){
 			$("#cal_moneybook"+calnum).append("<p class='text-info' style='line-height: 10px;'>"
 																+"<abbr title='"+item.cartegory+"'> "+Number(item.price).toLocaleString('en')+"</abbr></p>"); 
 			easum += item.price;
 			//지출 내역
 		}else if(item.moneybook_type == "expense"){
 			$("#cal_moneybook"+calnum).append("<p class='text-danger' style='line-height: 10px;'>"
																+"<abbr title='"+item.cartegory+"'> "+Number(item.price).toLocaleString('en')+"</abbr></p>"); 
 			exsum += item.price;
 		}
	}); 
    //콤마 추가
    sumdisp = Number(easum).toLocaleString('en');
    $("#easum").html(sumdisp);
    sumdisp = Number(exsum).toLocaleString('en');
    $("#exsum").html(sumdisp);
    //토요일, 일요일 색 지정
    for(var i=0; i<42; i+=7){
        tdDay.eq(i).css("color","red");
    }
    for(var i=6; i<42; i+=7){
        tdDay.eq(i).css("color","blue");
    }
} 

//데이터 등록
function setData(year, month){
	//지출, 수입내역 저장된 array값 초기화
	calendarList.length = 0;

	var insert_date = year + "-" + month;
	$.ajax({
		url : "calendar/select", 
		data : {"insert_date" : insert_date},
		dataType : "json",
		success : function(data){
			$(data).each(function(idx, item){
				var calendarJson = new Object();
				//insert_date 에서 일자만 가져와서 저장
				calendarJson.day = item.insert_date.substring(8,10);
				calendarJson.price = item.price;
				calendarJson.moneybook_type = item.moneybook_type;
				calendarJson.cartegory = item.cartegory;
				calendarList.push(calendarJson);
			})
			drawDays(calendarList);
		}
	})
}

//이전 달 이동
function movePrevMonth(){
    month--;
    if(month<=0){
        month=12;
        year--;
    }
    if(month<10){
        month=String("0"+month);
    }
    getNewInfo();
}

//다음 달 이동
function moveNextMonth(){
    month++;
    if(month>12){
        month=1;
        year++;
    }
    if(month<10){
        month=String("0"+month);
    }
    getNewInfo();
}

//월 변경 될 떄마다 새로운 일 값 삽입을 위해
function getNewInfo(){
	//날짜 초기화
    for(var i=0;i<42;i++){
        tdDay.eq(i).text("");
    }
    dayCount=0;
    firstDay = new Date(year,month-1,1);
    lastDay = new Date(year,month,0);

    setData(year, month);
}

//달력 일자 클릭시 모달창
$(document).on("click","div[name=cal_moneybook]",function(){

	//name:cal_moneybook 에 해당하는 id값 가져오기
    var moneybook_day = $(this).attr("id");
	//id에 해당하는 text값 가져오기
    moneybook_day = $("#"+moneybook_day).text();
  	//달력에 표시된 금액도 가져오기때문에 앞에 일자만 가져온 뒤 한자리숫자일 경우 공백을 제거
	moneybook_day = moneybook_day.substring(0,2);
  	//공백 제거
    moneybook_day = moneybook_day.trim();
  //10월이하 01,02,03 으로 변경
    if(moneybook_day<10){
    	moneybook_day=String("0"+moneybook_day);
    }
    var insert_date = year+"-"+month+"-"+moneybook_day;
    
	$.ajax({
    	url : "calendar/select",
    	data : {"insert_date" : insert_date},
    	dataType : "json",
    	success : function(data){
    		getCalendarModal(data, insert_date);
 
    	    $("#calendar_modal").modal("show");
    	},
		error : function(request, error){
			alert("실패");
			alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
		}
    })
})

//모달창 데이터 표현
function getCalendarModal(data, insert_date){
	var disp = "";
	var expenseDisp = "";
	var earningsDisp = "";
	
	disp += "<table class='table table-hover'>";
	disp += "<tr>";
	disp += "<th scope='row'></th>";
	disp += "<th scope='row'>금액</th>";
	disp += "<th scope='row'>분류</th>";
	disp += "<th scope='row'>내역</th>";
	disp += "</tr>";
	expenseDisp += disp;
	disp = disp.replace("<th scope='row'>분류</th>","");
	earningsDisp += disp;
	$(data).each(function(idx, item){
		if(item.moneybook_type == "expense"){
			expenseDisp += '<tr onclick="location.href='+'#'+'" style="cursor:pointer;" name="moneybook_detail" id="moneybook_detail'+idx+'">';
			expenseDisp += "<td></td>";
			expenseDisp += "<td style='display:none;'>"+item.insert_date+"</td>";
			expenseDisp += "<td style='display:none;'>"+item.no+"</td>";
			expenseDisp += "<td style='display:none;'>"+item.moneybook_type+"</td>";
			expenseDisp += "<td>"+item.price+"</td>";
			expenseDisp += "<td>"+item.type+"</td>";
			expenseDisp += "<td>"+item.cartegory+"</td>";
			expenseDisp += "</tr>";
		}else if(item.moneybook_type == "earnings"){
			earningsDisp += '<tr onclick="location.href='+'#'+'" style="cursor:pointer;"name="moneybook_detail" id="moneybook_detail'+idx+'">';
			earningsDisp += "<td></td>";
			earningsDisp += "<td style='display:none;'>"+item.insert_date+"</td>";
			earningsDisp += "<td style='display:none;'>"+item.no+"</td>";
			earningsDisp += "<td style='display:none;'>"+item.moneybook_type+"</td>";
			earningsDisp += "<td>"+item.price+"</td>";
			earningsDisp += "<td style='display:none;'></td>";
			earningsDisp += "<td>"+item.cartegory+"</td>";
			earningsDisp += "</tr>";
		}
	});
	expenseDisp += "</table>";
	earningsDisp += "</table>";
	
	$("#modal_expense").html(expenseDisp);
	$("#modal_earnings").html(earningsDisp);
}

$(document).on("click","tr[name=moneybook_detail]",function(){
	var detailDisp = "";
	var tr = $(this);
	/* children : 자식노드를 찾는 함수(td는 tr의 자식노드) */
	var td = tr.children();
	
	var detail_insert_date = td.eq(1).text();
	var detail_no = td.eq(2).text();
	var detail_moneybook_type = td.eq(3).text();
	var detail_price = td.eq(4).text();
	var detail_type = td.eq(5).text();
	var detail_cartegory = td.eq(6).text();
	
	detailDisp += "<form method='post'>";
	detailDisp += "<div class='form-group'>";
	detailDisp += "<label class='col-form-label' for='inputDefault'>날짜</label>";
	detailDisp += "<input type='date' class='form-control' value='"+detai_insert_date+"'>";
	detailDisp += "</div>";
	if(detail_moneybook_type == "expense"){
		detailDisp += "<div class='form-group'>";
		if(detail_type == "cash"){
			detailDisp += "<select class='custom-select'>";
			detailDisp += "<option selected=''>현금</option>";
			detailDisp += "<option>카드</option>";
		}else{
			detailDisp += "<select class='custom-select'>";
			detailDisp += "<option selected=''>현금</option>";
			detailDisp += "<option>카드</option>";
		}
		detailDisp += "</div>";
	}else
	detailDisp += "<div class='form-group'>";
	detailDisp += "<label class='col-form-label' for='inputDefault'>금액</label>";
	detailDisp += "<input type='text' class='form-control' id='price' value='"+detai_price+"'>";
	detailDisp += "</div>";
})

</script>
</th:block>
</html>



